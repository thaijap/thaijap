<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Cuisine Admin | ThaiJap</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="admin-body" style="background: #0a0a0a; color: white;">
    <header class="admin-header" style="border-bottom-color: #333;">
        <h1>TABLEAU DES COMMANDES</h1>
        <button onclick="toggleStockView()" class="btn-stock-toggle">MODIFIER DISPONIBILITÃ‰S</button>
    </header>

    <div id="stock-manager" style="display:none; background:#111; padding:20px; border-bottom:2px solid #333;">
        <div id="stock-list" class="stock-grid"></div>
    </div>

    <main id="admin-grid" class="admin-grid"></main>
    <audio id="notif" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCiqOVjzAS5Crn4SPBkY3btyJtuCBgddpY",
            databaseURL: "https://thaijap-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "thaijap",
            appId: "1:84821188454:web:0078ba82b4affbe0abb2a7"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let count = 0;
        db.ref('commandes').on('value', (snap) => {
            const data = snap.val();
            if(data && Object.keys(data).length > count) document.getElementById('notif').play().catch(()=>{});
            count = data ? Object.keys(data).length : 0;

            const container = document.getElementById('admin-grid');
            container.innerHTML = "";
            for(let id in data) {
                const o = data[id];
                container.innerHTML += `
                    <div class="order-card-pro ${o.statut==='PrÃªte'?'ready-pro':''}">
                        <div class="order-header">
                            <span class="table-num">TABLE ${o.table}</span>
                            <span class="time">${o.heure}</span>
                        </div>
                        ${o.menu ? `<div class="menu-tag">${o.menu}</div>` : ''}
                        <ul class="items-list">
                            ${o.articles.map(a => `<li><strong>${a.nom}</strong>${a.note ? `<br><small>ðŸ’¡ ${a.note}</small>` : ''}</li>`).join('')}
                        </ul>
                        <div class="order-footer">
                            <div class="total-price">${o.total}â‚¬</div>
                            <div class="btns">
                                <button class="btn-ready" onclick="db.ref('commandes/${id}').update({statut:'PrÃªte'})">V</button>
                                <button class="btn-del" onclick="if(confirm('Supprimer?'))db.ref('commandes/${id}').remove()">X</button>
                            </div>
                        </div>
                    </div>`;
            }
        });

        function toggleStockView() {
            const div = document.getElementById('stock-manager');
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
            if(div.style.display === 'block') chargerStock();
        }

        function chargerStock() {
            db.ref('/').once('value', (snap) => {
                const data = snap.val();
                let h = "";
                for(let id in data) {
                    if(id.startsWith('p')) {
                        const isOff = data[id].dispo === false;
                        h += `<div class="stock-item-pro">
                            <span>${data[id].nom}</span>
                            <button onclick="toggleProd('${id}', ${isOff})" class="${isOff?'off':'on'}">
                                ${isOff ? 'INDISPO' : 'EN STOCK'}
                            </button>
                        </div>`;
                    }
                }
                document.getElementById('stock-list').innerHTML = h;
            });
        }

        function toggleProd(id, off) {
            db.ref(id).update({dispo: off}).then(() => chargerStock());
        }
    </script>
</body>
</html>
