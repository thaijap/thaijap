<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Admin ThaiJap | Gestion & Encaissement</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Courier+Prime&display=swap" rel="stylesheet">
    <style>
        :root { --red: #BC002D; --black: #121212; --gold: #C5A059; --green: #2ecc71; --blue: #3498db; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: #000; color: #fff; display: flex; height: 100vh; overflow: hidden; }
        
        /* LAYOUT */
        .sidebar { width: 320px; background: #1a1a1a; border-right: 1px solid #333; display: flex; flex-direction: column; }
        .main { flex: 1; background: #050505; overflow-y: auto; padding: 10px; }
        .history { width: 320px; background: #111; overflow-y: auto; border-left: 1px solid #333; }
        .panel-header { padding: 15px; background: #000; color: var(--red); font-weight: 700; border-bottom: 2px solid var(--red); text-align: center; }

        /* STOCK ITEMS */
        .stock-item { background: #151515; padding: 10px; border-bottom: 1px solid #333; }
        .btn-toggle { border: none; padding: 4px 10px; cursor: pointer; border-radius: 3px; font-weight: 700; color: #fff; font-size: 0.65rem; }
        .on { background: var(--green); } .off { background: var(--red); }

        /* ORDERS */
        .order-card { background: #1a1a1a; padding: 15px; border-radius: 4px; border-top: 4px solid var(--red); margin-bottom: 15px; }
        .btn-pay { width: 48%; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: 700; color: #fff; }
        .btn-chef { width: 100%; padding: 10px; background: var(--blue); color: white; border: none; border-radius: 4px; font-weight: 700; cursor: pointer; margin-bottom: 10px; }

        /* PRINT STYLE */
        #print-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left:0; top:0; width: 100%; display: block !important; color: black; font-family: 'Courier Prime', monospace; padding: 20px; }
            .print-center { text-align: center; }
            .print-item { display: flex; justify-content: space-between; margin-bottom: 5px; }
        }
    </style>
</head>
<body>
    <div id="print-area"></div>

    <aside class="sidebar">
        <div class="panel-header">üì¶ STOCKS</div>
        <div id="stock-list"></div>
    </aside>

    <main class="main">
        <div class="panel-header">üî• COMMANDES EN COURS</div>
        <div id="order-list"></div>
    </main>

    <aside class="history">
        <div class="panel-header">üìä HISTORIQUE JOURNALIER</div>
        <div id="history-list"></div>
    </aside>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyCiqOVjzAS5Crn4SPBkY3btyJtuCBgddpY", 
            databaseURL: "https://thaijap-default-rtdb.europe-west1.firebasedatabase.app", 
            projectId: "thaijap", 
            appId: "1:84821188454:web:0078ba82b4affbe0abb2a7" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. GESTION DES STOCKS
        db.ref('/').on('value', snap => {
            const data = snap.val(); let h = "";
            ["entrees", "sushis", "plats", "boissons", "desserts"].forEach(cat => {
                h += `<div style="background:var(--red); padding:5px 10px; font-size:0.7rem; font-weight:700;">${cat.toUpperCase()}</div>`;
                for(let id in data) {
                    if(id.startsWith('p') && data[id].categorie === cat) {
                        const p = data[id]; const globalOff = p.dispo === false;
                        h += `<div class="stock-item">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <span style="font-size:0.85rem; color:var(--gold); font-weight:700;">${p.nom}</span>
                                <button class="btn-toggle ${globalOff?'off':'on'}" onclick="db.ref('${id}/dispo').set(${globalOff})">${globalOff?'OFF':'ON'}</button>
                            </div>`;
                        if(p.specials) {
                            p.specials.forEach((s, i) => { const sOff = s.dispo === false;
                                h += `<div style="display:flex;justify-content:space-between;font-size:0.75rem;margin-top:5px;padding-left:10px;"><span>${s.v}</span><button class="btn-toggle ${sOff?'off':'on'}" onclick="db.ref('${id}/specials/${i}/dispo').set(${sOff})">${sOff?'OFF':'ON'}</button></div>`;
                            });
                        } else if(p.options) {
                            p.options.forEach((o, i) => { const oOff = p.optionsDispo && p.optionsDispo[i] === false;
                                h += `<div style="display:flex;justify-content:space-between;font-size:0.75rem;margin-top:5px;padding-left:10px;"><span>${o}</span><button class="btn-toggle ${oOff?'off':'on'}" onclick="db.ref('${id}/optionsDispo/${i}').set(${!oOff})">${oOff?'OFF':'ON'}</button></div>`;
                            });
                        }
                        h += `</div>`;
                    }
                }
            });
            document.getElementById('stock-list').innerHTML = h;
        });

        // 2. COMMANDES & AFFICHAGE
        db.ref('commandes').on('value', snap => {
            const data = snap.val(); let oH = "", hH = ""; let totaux = {};
            for(let id in data) {
                const o = data[id]; const date = o.date || new Date().toLocaleDateString('fr-FR');
                if(o.statut === "Pay√©") {
                    if(!totaux[date]) totaux[date] = 0; totaux[date] += parseFloat(o.total);
                    hH = `<div style="padding:10px; border-bottom:1px solid #222; font-size:0.75rem;">T-${o.table} : ${o.total}‚Ç¨ (${o.modePaiement})</div>` + hH;
                } else {
                    oH += `<div class="order-card">
                        <div style="font-weight:700; color:var(--red);">TABLE ${o.table} <span style="float:right; color:#666;">${o.heure}</span></div>
                        <div style="margin:10px 0; font-size:0.85rem;">
                            ${o.articles.map(a => `‚Ä¢ <strong>${a.nom}</strong>${a.note?' <br><i style="color:var(--green)">Note: '+a.note+'</i>':''}`).join('<br>')}
                        </div>
                        <div style="text-align:right; font-weight:700; margin-bottom:10px;">TOTAL: ${o.total}‚Ç¨</div>
                        <button class="btn-chef" onclick="imprimerChef('${id}')">üë®‚Äçüç≥ TICKET CUISINE</button>
                        <div style="display:flex; justify-content:space-between;">
                            <button class="btn-pay" style="background:var(--green);" onclick="encaisser('${id}','ESPECES')">üí∂ ESP√àCES</button>
                            <button class="btn-pay" style="background:var(--blue);" onclick="encaisser('${id}','CB')">üí≥ CARTE (CB)</button>
                        </div>
                    </div>`;
                }
            }
            document.getElementById('order-list').innerHTML = oH;
            let histFinal = ""; for(let j in totaux) histFinal += `<div style="background:#222; padding:10px; font-weight:700; color:var(--gold);">${j} : ${totaux[j].toFixed(2)}‚Ç¨</div>`;
            document.getElementById('history-list').innerHTML = histFinal + hH;
        });

        // 3. FONCTION IMPRESSION CUISINE (GRANDES LETTRES + NOTES)
        function imprimerChef(id) {
            db.ref('commandes/'+id).once('value', s => {
                const o = s.val();
                let html = `<div class="print-center"><h1 style="font-size:40pt; margin:0;">TABLE ${o.table}</h1><p>${o.heure}</p></div><hr>`;
                o.articles.forEach(a => {
                    html += `<div style="font-size:24pt; margin-bottom:10px; border-bottom:1px dashed #000;">
                        <b>‚Ä¢ ${a.nom.toUpperCase()}</b>
                        ${a.note ? `<br><span style="background:#ddd; display:block; padding:5px; font-size:18pt;">NOTE: ${a.note.toUpperCase()}</span>` : ''}
                    </div>`;
                });
                document.getElementById('print-area').innerHTML = html;
                window.print();
            });
        }

        // 4. FONCTION ENCAISSEMENT + TICKET DE CAISSE
        function encaisser(id, mode) {
            db.ref('commandes/'+id).once('value', s => {
                const o = s.val();
                // Pr√©paration du ticket de caisse client
                let html = `
                    <div class="print-center">
                        <h2 style="margin:0;">THAI JAP</h2>
                        <p>Ticket de Caisse<br>Table: ${o.table} | ${o.heure}</p>
                        <hr>
                    </div>
                    <div style="font-size:12pt;">
                        ${o.articles.map(a => `
                            <div class="print-item">
                                <span>${a.nom}</span>
                                <span>${a.prix.toFixed(2)}‚Ç¨</span>
                            </div>
                        `).join('')}
                    </div>
                    <hr>
                    <div class="print-item" style="font-size:16pt; font-weight:bold;">
                        <span>TOTAL</span>
                        <span>${o.total}‚Ç¨</span>
                    </div>
                    <div class="print-center" style="margin-top:20px;">
                        Paiement par : ${mode}<br>
                        Merci de votre visite !
                    </div>
                `;
                
                document.getElementById('print-area').innerHTML = html;
                
                // On lance l'impression
                window.print();

                // Une fois imprim√©, on valide en base de donn√©es
                db.ref('commandes/'+id).update({ 
                    statut: "Pay√©", 
                    modePaiement: mode, 
                    date: new Date().toLocaleDateString('fr-FR') 
                });
            });
        }
    </script>
</body>
</html>
