<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Admin ThaiJap | Dashboard Complet</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Courier+Prime&display=swap" rel="stylesheet">
    <style>
        :root { --red: #BC002D; --black: #121212; --gold: #C5A059; --green: #2ecc71; --blue: #3498db; --grey: #1a1a1a; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: #000; color: #fff; display: flex; height: 100vh; overflow: hidden; }
        
        /* Layout */
        .sidebar { width: 340px; background: var(--grey); border-right: 1px solid #333; overflow-y: auto; }
        .main { flex: 1; background: #050505; display: flex; flex-direction: column; border-right: 1px solid #333; overflow-y: auto; }
        .history { width: 320px; background: #111; overflow-y: auto; }
        
        .panel-header { padding: 15px; background: #000; color: var(--red); font-weight: 700; border-bottom: 2px solid var(--red); text-align: center; position: sticky; top: 0; z-index: 10; }
        
        /* Commandes */
        .order-card { background: var(--grey); padding: 15px; border-radius: 8px; border-top: 4px solid var(--red); margin: 15px; position: relative; }
        .order-table { font-size: 1.2rem; font-weight: 700; color: var(--gold); margin-bottom: 10px; }
        .order-item { font-size: 0.9rem; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #333; }
        .order-note { color: var(--red); font-size: 0.75rem; font-style: italic; }
        
        /* Boutons */
        .btn-group { display: flex; gap: 5px; margin-top: 15px; }
        .btn { border: none; padding: 10px; border-radius: 4px; color: white; font-weight: 700; cursor: pointer; flex: 1; font-size: 0.7rem; }
        .btn-chef { background: var(--gold); color: black; }
        .btn-esp { background: var(--green); }
        .btn-cb { background: var(--blue); }
        
        /* Stocks */
        .stock-item { background: #151515; padding: 10px; border-bottom: 1px solid #333; }
        .btn-toggle { border: none; padding: 4px 10px; cursor: pointer; border-radius: 3px; font-weight: 700; color: #fff; font-size: 0.65rem; }
        .on { background: var(--green); } .off { background: var(--red); }
        .variant-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; padding-left: 15px; margin-top: 8px; border-left: 2px solid #444; }

        /* Impression */
        #print-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { display: block !important; position: absolute; left: 0; top: 0; width: 80mm; color: black; font-family: 'Courier Prime', monospace; }
            .print-chef { font-size: 20pt; font-weight: bold; }
            .print-client { font-size: 12pt; }
        }
    </style>
</head>
<body>
    <div id="print-area"></div>

    <aside class="sidebar no-print">
        <div class="panel-header">ðŸ“¦ STOCKS & OPTIONS</div>
        <div id="stock-list"></div>
    </aside>

    <main class="main no-print">
        <div class="panel-header">ðŸ”¥ COMMANDES EN CUISINE</div>
        <div id="order-list"></div>
    </main>

    <aside class="history no-print">
        <div class="panel-header">ðŸ“Š HISTORIQUE DU JOUR</div>
        <div id="day-total" style="text-align:center; padding:10px; background:var(--gold); color:black; font-weight:bold; font-size:1.1rem;">TOTAL : 0.00â‚¬</div>
        <div id="history-list"></div>
    </aside>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCiqOVjzAS5Crn4SPBkY3btyJtuCBgddpY", databaseURL: "https://thaijap-default-rtdb.europe-west1.firebasedatabase.app", projectId: "thaijap", appId: "1:84821188454:web:0078ba82b4affbe0abb2a7" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. GESTION DES STOCKS (ON/OFF)
        db.ref('/').on('value', snap => {
            const data = snap.val(); let sH = "";
            for(let id in data) {
                if(!id.startsWith('p')) continue;
                const p = data[id];
                sH += `<div class="stock-item">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span>${p.nom}</span>
                        <button class="btn-toggle ${p.dispo?'on':'off'}" onclick="db.ref('${id}/dispo').set(${!p.dispo})">${p.dispo?'ON':'OFF'}</button>
                    </div>`;
                if(p.options) {
                    p.options.forEach((opt, i) => {
                        sH += `<div class="variant-row"><span>${opt.n}</span><button class="btn-toggle ${opt.s?'on':'off'}" onclick="db.ref('${id}/options/${i}/s').set(${!opt.s})">${opt.s?'ON':'OFF'}</button></div>`;
                    });
                }
                if(p.specials) {
                    p.specials.forEach((spec, i) => {
                        sH += `<div class="variant-row"><span>${spec.v}</span><button class="btn-toggle ${spec.s?'on':'off'}" onclick="db.ref('${id}/specials/${i}/s').set(${!spec.s})">${spec.s?'ON':'OFF'}</button></div>`;
                    });
                }
                sH += `</div>`;
            }
            document.getElementById('stock-list').innerHTML = sH;
        });

        // 2. AFFICHAGE DES COMMANDES ET HISTORIQUE
        db.ref('commandes').on('value', snap => {
            const data = snap.val();
            let oH = "", hH = "", totalJour = 0;
            const today = new Date().toLocaleDateString('fr-FR');

            for(let id in data) {
                const o = data[id];
                if(o.statut === "PayÃ©") {
                    if(o.date === today) {
                        totalJour += parseFloat(o.total);
                        hH = `<div style="padding:10px; border-bottom:1px solid #333; font-size:0.8rem;">
                                <b>Table ${o.table}</b> - ${o.total}â‚¬ (${o.modePaiement})<br>
                                <small style="color:#666;">${o.heure}</small>
                              </div>` + hH;
                    }
                } else {
                    oH += `<div class="order-card">
                        <div class="order-table">TABLE ${o.table} <span style="float:right; font-size:0.7rem; color:#666;">${o.heure}</span></div>
                        <div style="color:var(--gold); font-size:0.7rem; margin-bottom:10px;">${o.menu || ''}</div>
                        <div>${o.articles.map(a => `
                            <div class="order-item">
                                â€¢ ${a.nom} ${a.note ? `<br><span class="order-note">Note: ${a.note}</span>` : ''}
                            </div>`).join('')}
                        </div>
                        <div style="text-align:right; font-weight:bold; margin-top:10px;">TOTAL: ${o.total}â‚¬</div>
                        <div class="btn-group">
                            <button class="btn btn-chef" onclick="imprimerChef('${id}')">TICKET CHEF</button>
                            <button class="btn btn-esp" onclick="encaisser('${id}','ESPÃˆCES')">CASH</button>
                            <button class="btn btn-cb" onclick="encaisser('${id}','CARTE CB')">CB</button>
                        </div>
                    </div>`;
                }
            }
            document.getElementById('order-list').innerHTML = oH;
            document.getElementById('history-list').innerHTML = hH;
            document.getElementById('day-total').innerText = "TOTAL : " + totalJour.toFixed(2) + "â‚¬";
        });

        // 3. FONCTION IMPRESSION CHEF (CUISINE)
        function imprimerChef(id) {
            db.ref('commandes/'+id).once('value', s => {
                const o = s.val();
                let html = `<div class="print-chef" style="text-align:center;">
                    <h1 style="font-size:40pt; margin:0;">TABLE ${o.table}</h1>
                    <p style="font-size:15pt;">Heure: ${o.heure}</p>
                    <hr style="border:2px solid black;">
                </div>`;
                o.articles.forEach(a => {
                    html += `<div style="font-size:24pt; margin-bottom:15px; border-bottom:1px dashed black; padding-bottom:5px;">
                        â€¢ ${a.nom.toUpperCase()}
                        ${a.note ? `<br><span style="font-size:18pt; background:black; color:white;"> !!! ${a.note.toUpperCase()} !!! </span>` : ''}
                    </div>`;
                });
                document.getElementById('print-area').innerHTML = html;
                window.print();
            });
        }

        // 4. FONCTION ENCAISSEMENT ET TICKET CLIENT
        function encaisser(id, mode) {
            db.ref('commandes/'+id).once('value', s => {
                const o = s.val();
                // PrÃ©paration du ticket client
                let html = `<div class="print-client" style="text-align:center;">
                    <img src="images/logo.png" style="width:120px;"><br>
                    <b style="font-size:16pt;">THAI JAP</b><br>
                    Table ${o.table} | ${o.heure}<br>
                    --------------------------------
                </div>`;
                o.articles.forEach(a => {
                    html += `<div style="display:flex; justify-content:space-between; font-size:10pt;">
                        <span>${a.nom}</span>
                        <span>${a.prix.toFixed(2)}â‚¬</span>
                    </div>`;
                });
                html += `<div style="text-align:center;">
                    --------------------------------<br>
                    <b style="font-size:14pt;">TOTAL : ${o.total}â‚¬</b><br>
                    Mode : ${mode}<br><br>
                    Merci de votre visite !
                </div>`;
                
                document.getElementById('print-area').innerHTML = html;
                window.print();

                // Mise Ã  jour base de donnÃ©es (bascule vers historique)
                db.ref('commandes/'+id).update({ 
                    statut: "PayÃ©", 
                    modePaiement: mode, 
                    date: new Date().toLocaleDateString('fr-FR') 
                });
            });
        }
    </script>
</body>
</html>
