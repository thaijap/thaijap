<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Admin ThaiJap | Correction Stock</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Courier+Prime&display=swap" rel="stylesheet">
    <style>
        :root { --red: #BC002D; --black: #121212; --gold: #C5A059; --green: #2ecc71; --blue: #3498db; --grey: #1a1a1a; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: #000; color: #fff; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 340px; background: var(--grey); border-right: 1px solid #333; display: flex; flex-direction: column; }
        .main { flex: 1; background: #050505; display: flex; flex-direction: column; border-right: 1px solid #333; }
        .history { width: 320px; background: #111; overflow-y: auto; border-left: 1px solid #333; }
        .panel-header { padding: 15px; background: #000; color: var(--red); font-weight: 700; border-bottom: 2px solid var(--red); text-align: center; }
        .stock-item { background: #151515; padding: 10px; border-bottom: 1px solid #333; }
        .btn-toggle { border: none; padding: 4px 10px; cursor: pointer; border-radius: 3px; font-weight: 700; color: #fff; font-size: 0.65rem; min-width: 45px; }
        .on { background: var(--green); } .off { background: var(--red); }
        .variant-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; padding-left: 15px; margin-top: 6px; border-left: 2px solid #333; }
        .order-card { background: var(--grey); padding: 15px; border-radius: 4px; border-top: 4px solid var(--red); margin-bottom: 15px; position: relative; }
        .btn-edit-order { position: absolute; right: 10px; top: 10px; background: none; border: 1px solid #444; color: var(--gold); padding: 3px 8px; cursor: pointer; font-size: 0.7rem; border-radius: 4px; }
        .terminal-box { height: 380px; background: #151515; border-top: 2px solid var(--gold); display: flex; flex-direction: column; }
        .terminal-grid { display: flex; flex: 1; overflow: hidden; }
        .term-products { flex: 2; overflow-y: auto; padding: 10px; }
        .term-cart { flex: 1; background: #0a0a0a; padding: 10px; display: flex; flex-direction: column; }
        .term-item { background: #222; margin-bottom: 5px; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .term-select { width: 100%; background: #000; color: #fff; border: 1px solid #444; margin-top: 5px; font-size: 0.75rem; }
        .btn-term-send { background: var(--gold); color: #000; border: none; padding: 10px; font-weight: 700; cursor: pointer; margin-top: auto; border-radius: 4px; }
        #print-area { display: none; }
        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left:0; top:0; width: 100%; display: block !important; color: black; font-family: 'Courier Prime', monospace; padding: 20px; } .print-center { text-align: center; } }
    </style>
</head>
<body>
    <div id="print-area"></div>
    <aside class="sidebar no-print">
        <div class="panel-header">üì¶ STOCKS & FARSES</div>
        <div id="stock-list" style="overflow-y:auto; flex:1;"></div>
    </aside>
    <main class="main no-print">
        <div class="panel-header">üî• EN COURS</div>
        <div id="order-list"></div>
        <div class="terminal-box">
            <div id="terminal-title" style="background:var(--gold); color:#000; font-size:0.75rem; padding:8px; font-weight:700; text-align:center;">PRISE DE COMMANDE INTERNE</div>
            <div class="terminal-grid">
                <div id="term-products" class="term-products"></div>
                <div class="term-cart">
                    <input type="text" id="term-table" placeholder="Table n¬∞" style="width:100%; padding:8px; margin-bottom:10px; background:#000; color:var(--gold); border:1px solid var(--gold);">
                    <div id="term-cart-list" style="flex:1; overflow-y:auto;"></div>
                    <div id="applied-menu-term" style="font-size:0.65rem; color:var(--gold); font-weight:700;"></div>
                    <div id="term-total" style="font-weight:700; color:var(--gold); padding:5px 0; border-top:1px solid #333;">TOTAL: 0.00‚Ç¨</div>
                    <button id="btn-main-terminal" class="btn-term-send" onclick="envoyerCommandeInterne()">ENVOYER</button>
                    <button id="btn-cancel-edit" style="display:none; background:#444; color:white; border:none; margin-top:5px; padding:5px;" onclick="annulerModification()">ANNULER</button>
                </div>
            </div>
        </div>
    </main>
    <aside class="history no-print">
        <div class="panel-header">üìä HISTORIQUE</div>
        <div id="history-list"></div>
    </aside>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCiqOVjzAS5Crn4SPBkY3btyJtuCBgddpY", databaseURL: "https://thaijap-default-rtdb.europe-west1.firebasedatabase.app", projectId: "thaijap", appId: "1:84821188454:web:0078ba82b4affbe0abb2a7" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let panierInterne = [], menuData = {}, editingOrderId = null;

        db.ref('/').on('value', snap => {
            menuData = snap.val();
            let sH = "", tH = "";
            const cats = ["entrees", "sushis", "plats", "boissons", "desserts"];
            cats.forEach(cat => {
                sH += `<div style="background:var(--red); padding:5px 10px; font-size:0.7rem; font-weight:700; margin-top:10px;">${cat.toUpperCase()}</div>`;
                tH += `<div style="color:var(--gold); font-size:0.6rem; font-weight:700; margin:5px 0;">-- ${cat.toUpperCase()} --</div>`;
                for(let id in menuData) {
                    if(id.startsWith('p') && menuData[id].categorie === cat) {
                        const p = menuData[id]; const isOff = p.dispo === false;
                        sH += `<div class="stock-item"><div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-weight:700;">${p.nom}</span><button class="btn-toggle ${isOff?'off':'on'}" onclick="db.ref('${id}/dispo').set(${isOff?true:false})">${isOff?'OFF':'ON'}</button></div>`;
                        if(p.options) {
                            p.options.forEach((o, i) => {
                                const oOff = p.optionsDispo && p.optionsDispo[i] === false;
                                sH += `<div class="variant-row"><span>${o}</span><button class="btn-toggle ${oOff?'off':'on'}" onclick="db.ref('${id}/optionsDispo/${i}').set(${!oOff})">${oOff?'OFF':'ON'}</button></div>`;
                            });
                        }
                        if(p.specials) {
                            p.specials.forEach((s, i) => {
                                const sOff = s.dispo === false;
                                sH += `<div class="variant-row"><span>${s.v}</span><button class="btn-toggle ${sOff?'off':'on'}" onclick="db.ref('${id}/specials/${i}/dispo').set(${!sOff})">${sOff?'OFF':'ON'}</button></div>`;
                            });
                        }
                        sH += `</div>`;
                        if(!isOff) {
                            tH += `<div class="term-item" onclick="ajouterAuPanierInterne('${id}')"><strong>${p.nom}</strong> ${p.prix ? p.prix.toFixed(2)+'‚Ç¨' : ''}
                                ${p.options ? `<select class="term-select" id="term-opt-${id}" onclick="event.stopPropagation()">${p.options.map((o,i)=>(p.optionsDispo && p.optionsDispo[i]===false)?'':`<option>${o}</option>`).join('')}</select>` : ''}
                                ${p.specials ? `<select class="term-select" id="term-spec-${id}" onclick="event.stopPropagation()">${p.specials.filter(s=>s.dispo!==false).map(s=>`<option value="${s.v}|${s.p}">${s.v} (${s.p.toFixed(2)}‚Ç¨)</option>`).join('')}</select>` : ''}
                            </div>`;
                        }
                    }
                }
            });
            document.getElementById('stock-list').innerHTML = sH;
            document.getElementById('term-products').innerHTML = tH;
        });

        function ajouterAuPanierInterne(id) {
            const p = menuData[id]; let nom = p.nom, prix = p.prix || 0;
            if(p.options) {
                const val = document.getElementById('term-opt-'+id).value;
                if(!val) return alert("Option √©puis√©e");
                nom += " (" + val + ")";
            }
            if(p.specials) { const s = document.getElementById('term-spec-'+id).value.split('|'); nom += " " + s[0]; prix = parseFloat(s[1]); }
            panierInterne.push({nom, prix, categorie: p.categorie});
            majPanierInterne();
        }

        function majPanierInterne() {
            let total = 0, temp = [...panierInterne], nF = 0, nG = 0, nT = 0;
            while (temp.filter(i => i.categorie === "sushis").length >= 5) { nF++; total += 44.90; for(let k=0; k<5; k++) temp.splice(temp.findIndex(i => i.categorie === "sushis"), 1); }
            while (true) {
                let iE = temp.findIndex(i => i.categorie === "entrees"), iP = temp.findIndex(i => i.categorie === "plats" && i.prix === 14.9), iB = temp.findIndex(i => i.categorie === "boissons");
                if (iE!==-1 && iP!==-1 && iB!==-1) { nG++; total+=20.90; temp.splice(iP,1); temp.splice(temp.findIndex(i=>i.categorie==="entrees"),1); temp.splice(temp.findIndex(i=>i.categorie==="boissons"),1); } else break;
            }
            while (true) {
                let iE = temp.findIndex(i => i.categorie === "entrees"), iS = temp.findIndex(i => i.categorie === "sushis"), iB = temp.findIndex(i => i.categorie === "boissons");
                if (iE!==-1 && iS!==-1 && iB!==-1) { nT++; total+=16.90; temp.splice(iS,1); temp.splice(temp.findIndex(i=>i.categorie==="entrees"),1); temp.splice(temp.findIndex(i=>i.categorie==="boissons"),1); } else break;
            }
            temp.forEach(i => total += i.prix);
            document.getElementById('term-total').innerText = "TOTAL: " + total.toFixed(2) + "‚Ç¨";
            document.getElementById('applied-menu-term').innerText = (nF>0?nF+" Family ":"") + (nG>0?nG+" Gourmand ":"") + (nT>0?nT+" Tokyo":"");
            document.getElementById('term-cart-list').innerHTML = panierInterne.map((i,idx) => `<div style="display:flex;justify-content:space-between;font-size:0.7rem;"><span>${i.nom}</span><span style="color:red;cursor:pointer;" onclick="panierInterne.splice(${idx},1);majPanierInterne()">‚úï</span></div>`).join('');
        }

        function chargerPourModification(id) {
            db.ref('commandes/' + id).once('value', snap => {
                const o = snap.val(); editingOrderId = id; panierInterne = [...o.articles];
                document.getElementById('term-table').value = o.table;
                document.getElementById('terminal-title').innerText = "MODIF. TABLE " + o.table;
                document.getElementById('btn-main-terminal').innerText = "METTRE √Ä JOUR";
                document.getElementById('btn-cancel-edit').style.display = "block";
                majPanierInterne();
            });
        }

        function annulerModification() { editingOrderId = null; panierInterne = []; document.getElementById('term-table').value = ""; document.getElementById('terminal-title').innerText = "PRISE DE COMMANDE INTERNE"; document.getElementById('btn-main-terminal').innerText = "ENVOYER"; document.getElementById('btn-cancel-edit').style.display = "none"; majPanierInterne(); }

        function envoyerCommandeInterne() {
            const table = document.getElementById('term-table').value;
            if(!table || panierInterne.length === 0) return alert("Table vide");
            const total = document.getElementById('term-total').innerText.split(': ')[1].replace('‚Ç¨','');
            const menu = document.getElementById('applied-menu-term').innerText;
            if(editingOrderId) {
                db.ref('commandes/' + editingOrderId).update({ articles: panierInterne, total, menu }).then(() => annulerModification());
            } else {
                db.ref('commandes').push({ table, articles: panierInterne, total, menu, statut: "En attente", heure: new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}) });
                panierInterne = []; document.getElementById('term-table').value = ""; majPanierInterne();
            }
        }

        db.ref('commandes').on('value', snap => {
            const data = snap.val(); let oH = "", hH = ""; let totaux = {};
            if(!data) return;
            for(let id in data) {
                const o = data[id], date = o.date || new Date().toLocaleDateString('fr-FR');
                if(o.statut === "Pay√©") {
                    if(!totaux[date]) totaux[date] = 0; totaux[date] += parseFloat(o.total);
                    hH = `<div style="padding:8px; border-bottom:1px solid #222; font-size:0.7rem;">T-${o.table} : ${o.total}‚Ç¨ (${o.modePaiement})</div>` + hH;
                } else {
                    oH += `<div class="order-card"><button class="btn-edit-order" onclick="chargerPourModification('${id}')">‚úèÔ∏è</button>
                        <div style="font-weight:700; color:var(--red);">T-${o.table} <small style="float:right; color:#666;">${o.heure}</small></div>
                        <div style="color:var(--gold); font-size:0.65rem;">${o.menu || ''}</div>
                        <div style="margin:8px 0; font-size:0.75rem; line-height:1.2;">${o.articles.map(a => `‚Ä¢ ${a.nom}${a.note?' <i style="color:var(--green)">('+a.note+')</i>':''}`).join('<br>')}</div>
                        <div style="text-align:right; font-weight:700; color:var(--gold);">TOTAL: ${o.total}‚Ç¨</div>
                        <button style="width:100%; padding:8px; background:var(--blue); border:none; color:#fff; font-weight:700; border-radius:4px; margin-top:8px; cursor:pointer;" onclick="imprimerChef('${id}')">üë®‚Äçüç≥ CUISINE</button>
                        <div style="display:flex; justify-content:space-between; margin-top:5px;"><button class="btn-pay" style="background:var(--green);" onclick="encaisser('${id}','ESP')">ESP</button><button class="btn-pay" style="background:var(--blue);" onclick="encaisser('${id}','CB')">CB</button></div></div>`;
                }
            }
            document.getElementById('order-list').innerHTML = oH;
            let histFinal = ""; for(let j in totaux) histFinal += `<div style="background:#222; padding:8px; font-weight:700; color:var(--gold);">${j} : ${totaux[j].toFixed(2)}‚Ç¨</div>`;
            document.getElementById('history-list').innerHTML = histFinal + hH;
        });

        function imprimerChef(id) {
            db.ref('commandes/'+id).once('value', s => {
                const o = s.val(); let html = `<div class="print-center"><h1 style="font-size:35pt;margin:0;">TABLE ${o.table}</h1><p>${o.heure}</p><hr></div>`;
                o.articles.forEach(a => { html += `<div style="font-size:22pt; margin-bottom:10px; border-bottom:1px dashed #000;">‚Ä¢ ${a.nom.toUpperCase()}${a.note ? `<br><small style="background:#eee;">NOTE: ${a.note.toUpperCase()}</small>` : ''}</div>`; });
                document.getElementById('print-area').innerHTML = html; window.print();
            });
        }

        function encaisser(id, mode) {
            db.ref('commandes/'+id).once('value', s => {
                const o = s.val(); let html = `<div class="print-center"><h2>THAI JAP</h2><p>Table ${o.table} | ${o.heure}</p><hr></div>${o.articles.map(a => `<div style="display:flex;justify-content:space-between;"><span>${a.nom}</span><span>${a.prix.toFixed(2)}‚Ç¨</span></div>`).join('')}<hr><div style="display:flex;justify-content:space-between;font-weight:bold;"><span>TOTAL</span><span>${o.total}‚Ç¨</span></div><p style="text-align:center;">Paiement : ${mode}</p>`;
                document.getElementById('print-area').innerHTML = html; window.print();
                db.ref('commandes/'+id).update({ statut: "Pay√©", modePaiement: mode, date: new Date().toLocaleDateString('fr-FR') });
            });
        }
    </script>
</body>
</html>
