<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Admin ThaiJap | Dashboard Expert</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Courier+Prime&display=swap" rel="stylesheet">
</head>
<body class="admin-layout-pro">

    <aside class="admin-sidebar stock-panel no-print">
        <div class="panel-header">üì¶ STOCKS</div>
        <div id="stock-list" class="scrollable"></div>
    </aside>

    <main class="admin-main orders-panel no-print">
        <div class="panel-header">üî• EN COURS</div>
        <div id="admin-grid" class="admin-grid"></div>
    </main>

    <aside class="admin-sidebar history-panel no-print">
        <div class="panel-header">üìä HISTORIQUE & VENTES</div>
        <div id="history-list" class="scrollable"></div>
    </aside>

    <div id="print-zone" class="only-print"></div>
    <audio id="notif" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCiqOVjzAS5Crn4SPBkY3btyJtuCBgddpY",
            databaseURL: "https://thaijap-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "thaijap",
            appId: "1:84821188454:web:0078ba82b4affbe0abb2a7"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- STOCKS ---
        db.ref('/').on('value', (snap) => {
            const data = snap.val();
            let h = "";
            for(let id in data) {
                if(id.startsWith('p')) {
                    const isOff = data[id].dispo === false;
                    h += `<div class="stock-item"><span>${data[id].nom}</span><button onclick="db.ref('${id}').update({dispo: ${isOff}})" class="${isOff?'off':'on'}">${isOff?'OFF':'ON'}</button></div>`;
                }
            }
            document.getElementById('stock-list').innerHTML = h;
        });

        // --- COMMANDES & HISTORIQUE ---
        let lastCount = 0;
        db.ref('commandes').on('value', (snap) => {
            const data = snap.val();
            const grid = document.getElementById('admin-grid');
            const historyDiv = document.getElementById('history-list');
            
            if(data && Object.keys(data).length > lastCount) document.getElementById('notif').play().catch(()=>{});
            lastCount = data ? Object.keys(data).length : 0;

            grid.innerHTML = "";
            let groups = {};

            for(let id in data) {
                const o = data[id];
                const dateCmd = o.date || new Date().toLocaleDateString('fr-FR');

                if(o.statut === "Pay√©") {
                    if(!groups[dateCmd]) groups[dateCmd] = { total: 0, list: [] };
                    groups[dateCmd].total += parseFloat(o.total);
                    groups[dateCmd].list.push(o);
                } else {
                    grid.innerHTML += `
                        <div class="order-card">
                            <div class="order-top"><span class="table-label">TABLE ${o.table}</span><span class="order-time">${o.heure}</span></div>
                            <div class="order-content">
                                ${o.articles.map((a, idx) => `
                                    <div class="item-line">
                                        <span>‚Ä¢ ${a.nom}</span>
                                        <div class="item-ctrl">
                                            <button onclick="modifier('${id}', ${idx}, 'plus')">+</button>
                                            <button onclick="modifier('${id}', ${idx}, 'moins')">-</button>
                                        </div>
                                    </div>`).join('')}
                            </div>
                            <div class="total-row">Total : <strong>${o.total}‚Ç¨</strong></div>
                            <div class="order-actions">
                                <button class="btn-print" onclick="imprimerCuisine('${id}')">üë®‚Äçüç≥ CHEF</button>
                                <button class="btn-cash" onclick="encaisser('${id}', 'Esp√®ces')">üí∂ ESP</button>
                                <button class="btn-card" onclick="encaisser('${id}', 'Carte')">üí≥ CB</button>
                                <button class="btn-del" onclick="if(confirm('Annuler?'))db.ref('commandes/${id}').remove()">X</button>
                            </div>
                        </div>`;
                }
            }

            let hHtml = "";
            for(let date in groups) {
                hHtml += `
                    <div class="history-day-wrapper">
                        <div class="history-day-header" onclick="toggleHistory(this)">
                            <strong>üìÖ ${date}</strong>
                            <span class="day-total">${groups[date].total.toFixed(2)}‚Ç¨</span>
                        </div>
                        <div class="history-day-details">
                            ${groups[date].list.map(cmd => `
                                <div class="history-item">
                                    <div class="h-item-info">
                                        <span class="h-time">${cmd.heure}</span>
                                        <span class="h-table">Table ${cmd.table}</span>
                                        <span class="h-mode">${cmd.modePaiement === 'Carte' ? 'üí≥ CB' : 'üí∂ ESP'}</span>
                                    </div>
                                    <strong class="h-price">${cmd.total}‚Ç¨</strong>
                                </div>`).join('')}
                        </div>
                    </div>`;
            }
            historyDiv.innerHTML = hHtml;
        });

        function toggleHistory(el) {
            const details = el.nextElementSibling;
            details.classList.toggle('active');
            document.querySelectorAll('.history-day-details').forEach(d => { if(d !== details) d.classList.remove('active'); });
        }

        function modifier(cid, idx, act) {
            db.ref(`commandes/${cid}`).once('value', (s) => {
                let c = s.val();
                if(act==='plus') c.articles.push({...c.articles[idx]}); else c.articles.splice(idx,1);
                let nt = c.articles.reduce((s,a)=>s+a.prix,0).toFixed(2);
                db.ref(`commandes/${cid}`).update({articles:c.articles, total:nt});
            });
        }

        function encaisser(id, mode) {
            db.ref(`commandes/${id}`).once('value', (s) => {
                const o = s.val();
                imprimerTicketClient(o, mode);
                db.ref(`commandes/${id}`).update({statut: "Pay√©", modePaiement: mode, date: new Date().toLocaleDateString('fr-FR')});
            });
        }

        function imprimerCuisine(id) {
            db.ref(`commandes/${id}`).once('value', (s) => {
                const o = s.val();
                let c = `<h1 style="font-size:30px">TABLE ${o.table}</h1><p>Heure: ${o.heure}</p><hr>`;
                o.articles.forEach(a => { c += `<h2>‚Ä¢ ${a.nom}</h2>${a.note ? `<p>Note: ${a.note}</p>` : ''}`; });
                document.getElementById('print-zone').innerHTML = c;
                window.print();
            });
        }

        function imprimerTicketClient(o, mode) {
            let c = `<div class="ticket"><h2>THAI JAP</h2><p>Table ${o.table} | ${o.heure}</p><hr>${o.articles.map(a => `<div class="t-line"><span>${a.nom}</span><span>${a.prix.toFixed(2)}‚Ç¨</span></div>`).join('')}<hr><div class="t-line"><strong>TOTAL</strong><strong>${o.total}‚Ç¨</strong></div><p>Paiement: ${mode}</p></div>`;
            document.getElementById('print-zone').innerHTML = c;
            window.print();
        }
    </script>
</body>
</html>
